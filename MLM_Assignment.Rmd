---
title: "Title of your report"
author: "fmcv76"
date: "02/04/24"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include = FALSE}

knitr::opts_chunk$set(echo = TRUE)

```

## Initial Data Loading and Checks 

```{r include = FALSE}

library(lme4)
library(lmerTest)
library(performance)
library(ggplot2)
library(scales)
library(sjPlot)
library(tidyverse)
library(tinytex)
library(wordcountaddin)

```

```{r}

# Load data 
mst_data_wide = read.csv("https://andygolightly.github.io/teaching/MATH43515/summative/alasdair.csv", 
                    header = TRUE)

# Preprocess long data 
mst_data = mst_data_wide %>% 
  tidyr::pivot_longer(cols = c(Responset1, Responset2, Responset3), 
                      names_to = "Time", 
                      values_to = "Response") %>% # Reshape data to long format 
  dplyr::mutate(Time = case_when(Time == "Responset1" ~ "1", 
                                 Time == "Responset2" ~ "2", 
                                 Time == "Responset3" ~ "3", 
                                 TRUE ~ NA)) %>% 
  dplyr::rename(Treatment = Trt, Nurse = ID) %>% 
  dplyr::mutate(Nurse = as.factor(Nurse), 
                Hospital = as.factor(Hospital), 
                Treatment = as.factor(Treatment), 
                Gender = as.factor(Gender), 
                Size = as.factor(Size), 
                Time = as.factor(Time))

# Preprocess wide data 
mst_data_wide = mst_data_wide %>% 
  dplyr::rename(Treatment = Trt, Nurse = ID) %>% 
  dplyr::mutate(Nurse = as.factor(Nurse), 
                Hospital = as.factor(Hospital), 
                Treatment = as.factor(Treatment), 
                Gender = as.factor(Gender), 
                Size = as.factor(Size))

# Check for NAs
colSums(is.na(mst_data))

```

## Introduction 

__Summary Statistics__

```{r echo = FALSE}

# Summary statistics 
mst_data_wide %>% 
  dplyr::select(-c(Nurse, Hospital)) %>% 
  summary()

```

```{r}

# Distribution of stress scores at month 1 by intervention group histogram 
ggplot(data = mst_data_wide, aes(x = Responset1, fill = Treatment)) +
  geom_histogram(aes(y = after_stat(count)), binwidth = 1, colour = "black", position = "identity", alpha = 0.3) +
  scale_fill_manual(values = c("1" = "red", "0" = "blue"), labels = c("1" = "Treatment Group", "0" = "Control Group"), guide_legend(title = "")) +
  scale_x_continuous(breaks = breaks_width(1), minor_breaks = NULL) +
  scale_y_continuous(breaks = breaks_width(2)) +
  labs(x = "Stress Score", y = "Count", title = "Distribution of Stress Scores Overlaid by Intervention Group - Month 1") +
  theme(panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5), axis.text = element_text(color = "black", size = 10),
        axis.title = element_text(size = 12), plot.title = element_text(size = 12, face = "bold"))

```

```{r}

# Distribution of stress scores at month 2 by intervention group histogram 
ggplot(data = mst_data_wide, aes(x = Responset2, fill = Treatment)) +
  geom_histogram(aes(y = after_stat(count)), binwidth = 1, colour = "black", position = "identity", alpha = 0.3) +
  scale_fill_manual(values = c("1" = "red", "0" = "blue"), labels = c("1" = "Treatment Group", "0" = "Control Group"), guide_legend(title = "")) +
  scale_x_continuous(breaks = breaks_width(1), minor_breaks = NULL) +
  scale_y_continuous(breaks = breaks_width(2)) +
  labs(x = "Stress Score", y = "Count", title = "Distribution of Stress Scores Overlaid by Intervention Group - Month 2") +
  theme(panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5), axis.text = element_text(color = "black", size = 10),
        axis.title = element_text(size = 12), plot.title = element_text(size = 12, face = "bold"))

```

```{r}

# Distribution of stress scores at month 3 by intervention group histogram 
ggplot(data = mst_data_wide, aes(x = Responset3, fill = Treatment)) +
  geom_histogram(aes(y = after_stat(count)), binwidth = 1, colour = "black", position = "identity", alpha = 0.3) +
  scale_fill_manual(values = c("1" = "red", "0" = "blue"), labels = c("1" = "Treatment Group", "0" = "Control Group"), guide_legend(title = "")) +
  scale_x_continuous(breaks = breaks_width(1), minor_breaks = NULL) +
  scale_y_continuous(breaks = breaks_width(2)) +
  labs(x = "Stress Score", y = "Count", title = "Distribution of Stress Scores Overlaid by Intervention Group - Month 3") +
  theme(panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5), axis.text = element_text(color = "black", size = 10),
        axis.title = element_text(size = 12), plot.title = element_text(size = 12, face = "bold"))

```

```{r}

# Distribution of stress scores over time by intervention group histogram 
ggplot(data = mst_data, aes(x = Time, y = Response, colour = Treatment)) +
  stat_boxplot(geom = "errorbar", width = 0.4, coef = 1.5, position = position_dodge(width = 0.75)) +
  geom_boxplot() +
  scale_colour_manual(values = c("1" = "#EC4646", "0" = "#4646EC"), labels = c("1" = "Treatment Group", "0" = "Control Group"), guide_legend(title = "")) +
  scale_y_continuous(breaks = breaks_width(2)) +
  labs(x = "Time (Months Since Treatment)", y = "Stress Score", title = "Distribution of Stress Scores Over Time by Intervention Group - Month 1") +
  theme(panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5), axis.text = element_text(color = "black", size = 10),
        axis.title = element_text(size = 12), plot.title = element_text(size = 12, face = "bold"))

```

```{r}

# Make time numeric for modelling 
mst_data = mst_data %>% 
  dplyr::mutate(Time = as.numeric(Time))

```

## Analysis 

__3-Level Intercept-Only Model for Time within Nurses within Hospitals__ 

```{r}

# Fit intercept-only model for nurses nested within hospitals 
hospital_nurse_intercept_only_model = lmer(formula = Response ~ 
                                           1 + (1 | Hospital) + 
                                           (1 | Hospital : Nurse), 
                                           data = mst_data)

summary(hospital_nurse_intercept_only_model)

# Calculate ICC 
icc(hospital_nurse_intercept_only_model)

```

__Calculating ICC and VPC Values__

```{r}

# Extract summary of variances 
var_summary = as.data.frame(VarCorr(hospital_nurse_intercept_only_model))

sig = var_summary$vcov[3]  # Residual variance 

sigv = var_summary$vcov[2] # RE variance for school 

sigu = var_summary$vcov[1] # RE variance for class 

totalvar = sum(var_summary$vcov) # Total variance 

vpc_hospital = round(100 * sigv / totalvar, 2)

vpc_nurse = round(100 * sigu / totalvar, 2)

icc_hospital = round(100 * sigv / totalvar, 2)

icc_nurse = round(100 * (sigu + sigv) / totalvar, 2)

```

Overall, there is a `r icc_nurse`% ICC value and therfore `r icc_nurse`% of the variation in Stress Scores can be exlained by the Time nested within Nurses nested within Hospitals grouping structure. There is a `r vpc_nurse`% Response variation (VPC) at the Nurse level and `r vpc_hospital`% VPC at the Hospital level, Therefore `r vpc_nurse`% of the variation in Stress Scores can be explained by the Nurses grouping structure and `r vpc_hospital`% of the variation in Stress Scores can be explained by the Hospitals grouping structure. The high variability between Nurses intuitively makes sense given that measurements pertaining to an individual Nurse should exhibit larger correlation than measurements from different Nurses. Therefore, the Nurse grouping structure should be include in modelling. The `r vpc_hospital`% variability between Hospitals is a relatively large ICC/VPC value in a healthcare setting and therfore the Hopsital grouping structure should be included in modelling. 

```{r}

# Fit random intercept model for time within nurses within hospitals with time level covariate 
random_intercept_timecovs_model = lmer(formula = Response ~ 
                                        1 + Time + 
                                        (1 | Hospital) + 
                                        (1 | Hospital : Nurse), 
                                        data = mst_data)

summary(random_intercept_timecovs_model)

```

Time stamp is statistically significant. 

__Comparison of 3-Level Intercept-Only Model with 3-Level Random Intercept Model with Time Stamp Time Level Covariate__

- Test the null hypothesis that $b_1=0$ and $b_{2}=0$ against an alternative that the fixed effects of Time is not 0. 

```{r}

anova(hospital_nurse_intercept_only_model, random_intercept_timecovs_model)

```

- The null hypothesis is rejected and Time Stamp is needed. 

## Word Count

```{r warning = FALSE, include = FALSE}

n_words = paste0("Word Count: ", as.character(word_count()))

```

```{r echo = FALSE}

print(n_words)

```
