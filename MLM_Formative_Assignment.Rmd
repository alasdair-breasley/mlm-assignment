---
title: "Title of your report"
author: "fmcv76"
date: "01/03/24"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include = FALSE}

knitr::opts_chunk$set(echo = TRUE)

```

## Initial Data Loading and Checks 

```{r include = FALSE}

library(lme4)
library(lmerTest)
library(ggplot2)
library(scales)
library(sjPlot)
library(tidyverse)
library(tinytex)
library(wordcountaddin)

```

```{r}

# Load data 
crt_data = read.csv("https://andygolightly.github.io/teaching/MATH43515/CRT.csv", 
                    header = TRUE)

# Preprocess data 
crt_data = crt_data %>% 
  dplyr::rename(Class = class) %>% 
  dplyr::mutate(Pupil = as.factor(Pupil),
                School = as.factor(School),
                Intervention = as.factor(Intervention),
                FSM = as.factor(FSM),
                Class = as.factor(Class))

# Check for NAs 
colSums(is.na(crt_data))

```

## Introduction 

- Randomised Control Trials (RCTs) are used to assess the effectiveness of an intervention. Individuals are randomly assigned to either the treatment or control group and this aims to prevent systematic differences between intervention groups with regards to both observables and unobservables, preventing selection into treatment bias. 
- In an educational setting, it may be neither practical nor ethical to administer an intervention at the Pupil or Class level. Providing an intervention at the Pupil level may not be practical or ethical given it would be practically challenging and could be seen as immoral for a teacher to provide some Pupils within a single Class with an intervention and not others. Providing an intervention at the Class level may be more practical than at the Pupil level but may still not be ethical as it could be seen as immoral for a School to provide Pupils in one Class with an intervention and not others. 
- This is where Cluster Randomised Control Trials (CRCTs) are useful. A CRCT in an educational setting can allow for an intervention to be administered at the School level, with less practical and ethical issues. Schools are randomly assigned to either the treatment or control group. 
- This report will assess the results of a 3-level educational CRCT. 20 Schools were randomly assigned to either the control or treatment group, with the treatment group receiving an educational intervention to try and improve Pupils test performance. Pupils test scores were calculated for 2 Classes per School, with test scores calculated both pre and post educational intervention. It is not clear how the initial 20 Schools were selected from the wider population of Schools in the country so there may be selection into experiment bias present. It appears that some Schools and Pupils dropped out of the study so there may be selection into observation bias present, with evidence of this being the absence of School IDs 18 and 19, and Pupil IDs 256, 257 and 258. 
- The variables collected as part of the CRCT were:
  - __Pupil__ - Anonymised Pupil ID. 
  - __Class__ - Anonymised Class ID. 
  - __School__ - Anonymised School ID. 
  - __Intervention__ - Flag indicating whether a Pupil is in the control or treatment. 
  - __FSM__ - Flag indicating whether a Pupil is eligible for free school meals. 
  - __Pretest__ - A pre-intervention test score for each Pupil. 
  - __Posttest__ - A post-intervention test score for each Pupil. 

```{r echo = FALSE}

# Distribution of Pretest scores by intervention group histogram 
ggplot(data = crt_data, aes(x = Pretest, fill = Intervention)) +
  geom_histogram(aes(y = after_stat(count)), binwidth = 1, colour = "black", position = "identity", alpha = 0.3) +
  scale_fill_manual(values = c("1" = "red", "0" = "blue"), labels = c("1" = "Treatment Group", "0" = "Control Group"), guide_legend(title = "")) +
  scale_x_continuous(breaks = breaks_width(1), minor_breaks = NULL) +
  scale_y_continuous(breaks = breaks_width(10)) +
  labs(x = "Pretest Scores", y = "Count", title = "Distribution of Pretest Scores Overlaid by Intervention Group") +
  theme(panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5), axis.text = element_text(color = "black", size = 10),
        axis.title = element_text(size = 12), plot.title = element_text(size = 12, face = "bold"))

```

- There is a similar distribution of Pretest scores for both the control and treatment groups with slightly more Pupils in the treatment group. 

```{r echo = FALSE}

# Distribution of Posttest scores by intervention group histogram 
ggplot(data = crt_data, aes(x = Posttest, fill = Intervention)) +
  geom_histogram(aes(y = after_stat(count)), binwidth = 4, colour = "black", position = "identity", alpha = 0.3) +
  scale_fill_manual(values = c("1" = "red", "0" = "blue"), labels = c("1" = "Treatment Group", "0" = "Control Group"), guide_legend(title = "")) +
  scale_x_continuous(breaks = breaks_width(4), minor_breaks = NULL) +
  scale_y_continuous(breaks = breaks_width(10)) +
  labs(x = "Posttest Scores", y = "Count", title = "Distribution of Posttest Scores Overlaid by Intervention Group") +
  theme(panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5), axis.text = element_text(color = "black", size = 10),
        axis.title = element_text(size = 12), plot.title = element_text(size = 12, face = "bold"))

```

- Posttest scores are higher across both the control and treatment group. The distribution of Posttest scores for the treatment group appears to be shifted to the right with higher scores on average and no longer follows a similar distribution to the control group (like Pretest). 

```{r echo = FALSE}

pvp_cor = round(cor(crt_data$Pretest, crt_data$Posttest, method = "spearman"), 2)

# Pretest scores vs Postest scores scatter plot 
ggplot(crt_data, aes(x = Pretest, y = Posttest)) +
  geom_point() +
  geom_smooth(formula = y ~ x, method = "lm", color = "blue", se = TRUE) +
  scale_x_continuous(breaks = breaks_width(1)) +
  scale_y_continuous(breaks = breaks_width(2)) +
  labs(x = "Pretest Score", y = "Posttest Score", title = "Pretest Scores vs Posttest Scores") +
  theme(panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5), axis.text = element_text(color = "black", size = 10),
        axis.title = element_text(size = 12), plot.title = element_text(size = 12, face = "bold"))

```

- There is a moderate positive Spearman's correlation of `r pvp_cor` between Pretest and Posttest scores. Spearman's was used as Pretest does not appear to be normally distributed. Grey area represents the 95% confidence interval. 

#### Summary Statistics 

```{r echo = FALSE}

# Summary statistics 
crt_data %>% 
  dplyr::select(-c(Pupil, Class)) %>% 
  dplyr::select(School, Intervention, FSM, Pretest, Posttest) %>% 
  summary()

```

\newpage

#### Pupils per School 

```{r echo = FALSE}

pps_df = as.data.frame(table(crt_data$School))

names(pps_df) = c("School", "Pupils")

print(pps_df, row.names = FALSE)

```

Note: There are no Pupils for Schools 18 or 19. 

## Methods 

- Multilevel models help solve the problem when analysing hierarchical data of lower-level-units belonging to the same upper-level-item being correlated. Multilevel models are appropriate for use in this case given the hierarchical structure of the data collected from the 3-level CRCT and the cluster randomisation used. In this context multilevel models can provide more accurate estimates of treatment effects than models which ignore the hierarchical data structure by accounting for the correlation within clusters. 
- The 3-level structure of the data is as follows: Pupils nested within Classes nested within Schools. 
- The covariates at the Pupil level are: FSM and Pretest. 
- There are no covariates at the Class level. 
- The covariate at the School level is: Intervention. 

## Word Count

```{r warning = FALSE, include = FALSE}

n_words = paste0("Word Count: ", as.character(word_count()))

```

```{r echo = FALSE}

print(n_words)

```
